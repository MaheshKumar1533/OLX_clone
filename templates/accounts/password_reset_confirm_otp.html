{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Confirm Password Reset - STUDYSWAP{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <i class="fas fa-shield-alt text-primary" style="font-size: 3rem;"></i>
                        </div>
                        <h2>Verify & Reset Password</h2>
                        <p class="text-muted mb-0">We've sent a 6-digit code to</p>
                        <p class="text-primary fw-bold">{{ email }}</p>
                        <small class="text-muted">Enter the code and your new password below</small>
                    </div>

                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            {{ form.otp_code|as_crispy_field }}
                            <div class="form-text">
                                <i class="fas fa-clock me-1"></i>
                                Code expires in <span id="countdown" class="fw-bold text-danger">10:00</span>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="mb-3">
                            <label for="id_new_password1" class="form-label">New Password</label>
                            <div class="input-group">
                                <input type="password" name="new_password1" class="form-control" 
                                       placeholder="Enter new password" id="id_new_password1" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('id_new_password1', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="id_new_password2" class="form-label">Confirm Password</label>
                            <div class="input-group">
                                <input type="password" name="new_password2" class="form-control" 
                                       placeholder="Confirm new password" id="id_new_password2" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('id_new_password2', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <i class="fas fa-check-circle me-2"></i>Verify & Reset Password
                        </button>
                        
                        <div class="d-grid">
                            <button type="button" id="resendBtn" class="btn btn-outline-secondary" disabled>
                                <i class="fas fa-redo me-2"></i>Resend Code <span id="resendTimer"></span>
                            </button>
                        </div>
                    </form>

                    <div class="text-center mt-3">
                        <a href="{% url 'accounts:password-reset' %}" class="text-muted">
                            <i class="fas fa-arrow-left me-1"></i>Back to password reset
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // OTP expiry countdown (10 minutes = 600 seconds)
    let timeLeft = 600;
    const countdownEl = document.getElementById('countdown');
    
    const countdownInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            countdownEl.textContent = 'EXPIRED';
            countdownEl.classList.add('text-danger');
        } else if (timeLeft <= 60) {
            countdownEl.classList.add('text-danger');
        }
    }, 1000);
    
    // Resend button countdown (60 seconds)
    let resendTimeLeft = 60;
    const resendBtn = document.getElementById('resendBtn');
    const resendTimer = document.getElementById('resendTimer');
    
    const resendInterval = setInterval(() => {
        resendTimeLeft--;
        resendTimer.textContent = `(${resendTimeLeft}s)`;
        
        if (resendTimeLeft <= 0) {
            clearInterval(resendInterval);
            resendBtn.disabled = false;
            resendTimer.textContent = '';
        }
    }, 1000);
    
    // Handle resend button click
    resendBtn.addEventListener('click', function() {
        fetch('{% url "accounts:resend-password-reset-otp" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Reset timers
                timeLeft = 600;
                resendTimeLeft = 60;
                resendBtn.disabled = true;
                
                // Show success message
                alert('✓ New verification code sent to your email!');
                
                // Restart intervals
                clearInterval(resendInterval);
                const newResendInterval = setInterval(() => {
                    resendTimeLeft--;
                    resendTimer.textContent = `(${resendTimeLeft}s)`;
                    
                    if (resendTimeLeft <= 0) {
                        clearInterval(newResendInterval);
                        resendBtn.disabled = false;
                        resendTimer.textContent = '';
                    }
                }, 1000);
            } else {
                alert('❌ ' + (data.message || 'Failed to resend code. Please try again.'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Failed to resend code. Please try again.');
        });
    });
</script>
{% endblock %}
