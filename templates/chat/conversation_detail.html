{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load chat_filters %}

{% block title %}Chat - {{ conversation.product.title }} - STUDISWAP{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Chat Header -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col-md-7">
                            <div class="d-flex align-items-center">
                                <a href="{% url 'chat:conversation_list' %}" class="text-white me-3">
                                    <i class="fas fa-arrow-left"></i>
                                </a>
                                {% if conversation.product.images.first %}
                                    <img src="{{ conversation.product.images.first.image.url }}" 
                                         class="rounded me-3" width="50" height="50" style="object-fit: cover;">
                                {% endif %}
                                <div>
                                    <h5 class="mb-0">{{ conversation.product.title }}</h5>
                                    <small class="text-light">
                                        Chat with {{ other_user.get_full_name|default:other_user.username }}
                                    </small>
                                    <br>
                                    <small id="connectionStatus" class="badge bg-success">
                                        <i class="fas fa-circle me-1" style="font-size: 0.6em;"></i>Connected
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5 text-end">
                            <span class="badge bg-light text-dark">
                                â‚¹{{ conversation.product.price }}
                            </span>
                            <a href="{% url 'products:product_detail' conversation.product.slug %}" 
                               class="btn btn-sm btn-outline-light ms-2">
                                View Product
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="card">
                <div class="card-body p-0">
                    <div class="chat-container" id="chatContainer" style="height: 400px; overflow-y: auto;">
                        {% if chat_messages %}
                            {% for message in chat_messages %}
                                <div class="message-bubble {% if message.sender == request.user %}sent{% else %}received{% endif %} p-3 m-2">
                                    <div class="message-content">
                                        <div class="message-header d-flex justify-content-between align-items-center mb-2">
                                            <strong class="message-sender">
                                                {{ message.sender.get_full_name|default:message.sender.username }}
                                            </strong>
                                            <small class="text-muted message-time">
                                                {{ message.created_at|date:"M j, Y g:i A" }}
                                            </small>
                                        </div>
                                        <div class="message-text">
                                            {{ message.content|mask_phone_numbers|linebreaks }}
                                        </div>
                                        {% if message.sender == request.user %}
                                            <div class="text-end mt-1">
                                                <small class="text-muted">
                                                    {% if message.is_read %}
                                                        <i class="fas fa-check-double text-primary" title="Read"></i>
                                                    {% else %}
                                                        <i class="fas fa-check" title="Sent"></i>
                                                    {% endif %}
                                                </small>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-comment text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-3">No messages yet. Start the conversation!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Message Input -->
                <div class="card-footer">
                    <form id="messageForm">
                        {% csrf_token %}
                        <div class="input-group">
                            {{ message_form.content }}
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-info-circle me-1"></i>Messages are sent in real-time. Press Enter to send, Shift+Enter for new line.
                        </small>
                    </form>
                </div>
            </div>

            <!-- Pagination for older messages -->
            {% if chat_messages.has_other_pages %}
                <div class="text-center mt-3">
                    {% if chat_messages.has_previous %}
                        <a href="?page={{ chat_messages.previous_page_number }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chevron-up me-1"></i>Load Older Messages
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.chat-container {
    background: linear-gradient(to bottom, #f8f9fa, #ffffff);
    border-radius: 0.375rem;
    padding: 10px;
}

.message-bubble {
    border-radius: 15px;
    max-width: 70%;
    word-wrap: break-word;
    animation: fadeIn 0.3s ease-in;
}

.message-bubble.sent {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    text-align: right;
}

.message-bubble.received {
    background-color: #e9ecef;
    color: #333;
    margin-right: auto;
}

.message-bubble.sent .message-sender {
    color: #cce7ff;
}

.message-bubble.sent .message-time {
    color: #cce7ff;
}

.message-content {
    position: relative;
}

.message-text {
    margin: 0;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

#id_content {
    border: 1px solid #ced4da;
    border-radius: 0.375rem 0 0 0.375rem;
    resize: none;
}

#id_content:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn-primary {
    border-radius: 0 0.375rem 0.375rem 0;
}
</style>

<script>
// WebSocket connection for real-time chat
const conversationId = {{ conversation.pk }};
const currentUserId = {{ request.user.id }};
const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const chatSocket = new WebSocket(
    protocol + '//' + window.location.host + '/ws/chat/' + conversationId + '/'
);

let typingTimer;
const typingTimeout = 1000;

chatSocket.onopen = function(e) {
    console.log('WebSocket connection established');
    updateConnectionStatus('connected');
};

chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    
    if (data.type === 'message') {
        // Add new message to chat
        addMessageToChat(data);
    } else if (data.type === 'typing') {
        // Show/hide typing indicator
        handleTypingIndicator(data);
    }
};

chatSocket.onclose = function(e) {
    console.log('WebSocket connection closed');
    updateConnectionStatus('disconnected');
    // Show reconnection message
    showReconnectionMessage();
};

chatSocket.onerror = function(e) {
    console.error('WebSocket error:', e);
    updateConnectionStatus('error');
};

function updateConnectionStatus(status) {
    const statusBadge = document.getElementById('connectionStatus');
    if (statusBadge) {
        if (status === 'connected') {
            statusBadge.className = 'badge bg-success';
            statusBadge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.6em;"></i>Connected';
        } else if (status === 'disconnected') {
            statusBadge.className = 'badge bg-secondary';
            statusBadge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.6em;"></i>Disconnected';
        } else if (status === 'error') {
            statusBadge.className = 'badge bg-danger';
            statusBadge.innerHTML = '<i class="fas fa-exclamation-circle me-1" style="font-size: 0.6em;"></i>Error';
        }
    }
}

function addMessageToChat(data) {
    const chatContainer = document.getElementById('chatContainer');
    const isOwnMessage = data.sender_id === currentUserId;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-bubble ${isOwnMessage ? 'sent' : 'received'} p-3 m-2`;
    messageDiv.style.animation = 'fadeIn 0.3s ease-in';
    
    // Mask phone numbers in the message
    const maskedMessage = maskPhoneNumbers(data.message);
    
    messageDiv.innerHTML = `
        <div class="message-content">
            <div class="message-header d-flex justify-content-between align-items-center mb-2">
                <strong class="message-sender">${data.sender_name}</strong>
                <small class="text-muted message-time">${data.timestamp}</small>
            </div>
            <div class="message-text">${escapeHtml(maskedMessage)}</div>
            ${isOwnMessage ? `
                <div class="text-end mt-1">
                    <small class="text-muted">
                        <i class="fas fa-check" title="Sent"></i>
                    </small>
                </div>
            ` : ''}
        </div>
    `;
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]).replace(/\n/g, '<br>');
}

function maskPhoneNumbers(text) {
    if (!text) return text;
    
    // Array of regex patterns to match phone numbers
    const patterns = [
        // Indian numbers with +91 country code
        /\+91[\s-]?\d{5}[\s-]?\d{5}/g,
        /\+91[\s-]?\d{10}/g,
        
        // Indian numbers with 0 prefix
        /\b0\d{10}\b/g,
        
        // 10-digit numbers starting with 6-9 (Indian mobile)
        /\b[6-9]\d{9}\b/g,
        
        // Numbers with spaces/hyphens/dots
        /\b\d{3}[\s.-]\d{3}[\s.-]\d{4}\b/g,
        /\b\d{5}[\s.-]\d{5}\b/g,
        
        // Numbers with parentheses
        /\(\d{3}\)[\s.-]?\d{3}[\s.-]?\d{4}/g,
        
        // International format
        /\+\d{1,3}[\s.-]?\d{3,4}[\s.-]?\d{3,4}[\s.-]?\d{3,4}/g,
        /\+\d{1,3}[\s.-]?\d{10,12}/g
    ];
    
    let maskedText = text;
    
    patterns.forEach(pattern => {
        maskedText = maskedText.replace(pattern, (match) => {
            // Replace all digits with asterisks while keeping format
            return match.replace(/\d/g, '*');
        });
    });
    
    return maskedText;
}

function handleTypingIndicator(data) {
    const typingIndicator = document.getElementById('typingIndicator');
    if (!typingIndicator) {
        const chatContainer = document.getElementById('chatContainer');
        const indicator = document.createElement('div');
        indicator.id = 'typingIndicator';
        indicator.className = 'typing-indicator p-2 m-2 text-muted';
        indicator.innerHTML = '<em><i class="fas fa-circle-notch fa-spin me-2"></i>' + data.user + ' is typing...</em>';
        chatContainer.appendChild(indicator);
    }
    
    if (!data.is_typing) {
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
}

function showReconnectionMessage() {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'alert alert-warning text-center m-3';
    messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Connection lost. Please refresh the page to reconnect.';
    document.getElementById('chatContainer').appendChild(messageDiv);
}

// Send message on form submit
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('id_content');
    const message = messageInput.value.trim();
    
    if (message) {
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        
        messageInput.value = '';
        messageInput.style.height = 'auto';
    }
});

// Typing indicator
const messageInput = document.getElementById('id_content');
messageInput.addEventListener('input', function() {
    clearTimeout(typingTimer);
    
    // Send typing started
    chatSocket.send(JSON.stringify({
        'typing': true
    }));
    
    // Set timeout to send typing stopped
    typingTimer = setTimeout(() => {
        chatSocket.send(JSON.stringify({
            'typing': false
        }));
    }, typingTimeout);
});

// Auto-scroll to bottom of chat
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chatContainer');
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Auto-resize textarea
    const textarea = document.getElementById('id_content');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // Send message on Enter (but not Shift+Enter)
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                // Trigger the form submit event which will be handled by WebSocket
                document.getElementById('messageForm').dispatchEvent(new Event('submit'));
            }
        });
    }
    
    // Mark messages as read when page loads
    fetch('{% url "chat:mark_messages_read" conversation.pk %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    });
});
</script>
{% endblock %}
